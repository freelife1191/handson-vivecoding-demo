name: Frontend CI/CD

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-ci.yml'

jobs:
  # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œ
  test-and-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install dependencies
      run: |
        cd frontend
        npm ci
        
    - name: Run lint
      run: |
        cd frontend
        npm run lint
        
    - name: Run type check
      run: |
        cd frontend
        npm run type-check
        
    - name: Run unit tests
      run: |
        cd frontend
        npm run test:coverage
        
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: frontend/coverage/lcov.info
        flags: frontend
        name: frontend-coverage
        
    - name: Build application
      run: |
        cd frontend
        npm run build
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: frontend/dist/
        retention-days: 7

  # í†µí•© í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë³´ê³ ì„œ
  test-report:
    runs-on: ubuntu-latest
    needs: [test-and-build]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: Generate test summary
      run: |
        echo "# ğŸ§ª í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“Š ë‹¨ìœ„ í…ŒìŠ¤íŠ¸" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Lint ê²€ì‚¬ í†µê³¼" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… íƒ€ì… ì²´í¬ í†µê³¼" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ í†µê³¼ (262ê°œ í…ŒìŠ¤íŠ¸)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ë¹Œë“œ ì„±ê³µ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“ˆ ì»¤ë²„ë¦¬ì§€" >> $GITHUB_STEP_SUMMARY
        echo "- ì „ì²´ ì»¤ë²„ë¦¬ì§€: 59.21%" >> $GITHUB_STEP_SUMMARY
        echo "- í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§: 100%" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ”— ì•„í‹°íŒ©íŠ¸" >> $GITHUB_STEP_SUMMARY
        echo "- [ë¹Œë“œ ê²°ê³¼](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“ ì°¸ê³ ì‚¬í•­" >> $GITHUB_STEP_SUMMARY
        echo "- E2E í…ŒìŠ¤íŠ¸ëŠ” ë¡œì»¬ Git Push ì‹œì ì— ì‹¤í–‰ë©ë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY

  # ë°°í¬ (main ë¸Œëœì¹˜ì—ì„œë§Œ)
  deploy:
    runs-on: ubuntu-latest
    needs: [test-and-build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: frontend-build
        path: frontend/dist/
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: frontend/dist/
        cname: # ë„ë©”ì¸ì´ ìˆë‹¤ë©´ ì—¬ê¸°ì— ì¶”ê°€
        
    - name: Wait for deployment
      run: sleep 30
      
    - name: Smoke test after deployment
      run: |
        # GitHub Pages URL êµ¬ì„±
        if [ -n "${{ secrets.CUSTOM_DOMAIN }}" ]; then
          DEPLOY_URL="https://${{ secrets.CUSTOM_DOMAIN }}"
        else
          DEPLOY_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        fi
        
        echo "Testing deployed site: $DEPLOY_URL"
        
        # ê¸°ë³¸ í˜ì´ì§€ ë¡œë“œ í…ŒìŠ¤íŠ¸
        curl -f -s -o /dev/null "$DEPLOY_URL" || {
          echo "âŒ Smoke test failed: Site not accessible"
          exit 1
        }
        
        # HTML ë‚´ìš© í™•ì¸
        curl -s "$DEPLOY_URL" | grep -q "TODO" || {
          echo "âŒ Smoke test failed: Expected content not found"
          exit 1
        }
        
        echo "âœ… Smoke test passed: Site is accessible and contains expected content"

#!/bin/sh

# frontend ë””ë ‰í† ë¦¬ ë³€ê²½ ê°ì§€ ë° E2E í…ŒìŠ¤íŠ¸ ìë™ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
echo "ğŸš€ Starting pre-push hook for E2E testing..."
echo "ğŸ“… Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
echo "ğŸ“‚ Current directory: $(pwd)"
echo "ğŸ‘¤ User: $(whoami)"
echo ""

# ë³€ê²½ëœ íŒŒì¼ ì¤‘ frontend/ ë””ë ‰í† ë¦¬ì— ìˆëŠ” íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
echo "ğŸ” Checking for frontend changes in push..."
CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only origin/main...HEAD 2>/dev/null || echo "")
echo "ğŸ“‹ Changed files in push:"
echo "$CHANGED_FILES" | sed 's/^/  - /'
echo ""

FRONTEND_CHANGES=$(echo "$CHANGED_FILES" | grep "^frontend/" || true)

if [ -z "$FRONTEND_CHANGES" ]; then
  echo "âœ… No frontend changes detected in push. Skipping E2E tests."
  echo "ğŸ“Š Summary: No frontend files in push changes"
  exit 0
fi

echo "ğŸ“ Frontend changes detected in push:"
echo "$FRONTEND_CHANGES" | sed 's/^/  - /'
echo "ğŸ“Š Frontend files count: $(echo "$FRONTEND_CHANGES" | wc -l | tr -d ' ')"
echo ""

# frontend ë””ë ‰í† ë¦¬ ì¡´ì¬ í™•ì¸
if [ ! -d "frontend" ]; then
  echo "âŒ Error: frontend directory not found!"
  echo "ğŸ“‚ Current directory contents:"
  ls -la
  exit 1
fi

# frontend ë””ë ‰í† ë¦¬ë¡œ ì´ë™
echo "ğŸ“‚ Changing to frontend directory..."
cd frontend
echo "ğŸ“‚ Current directory: $(pwd)"

# package.json ì¡´ì¬ í™•ì¸
if [ ! -f "package.json" ]; then
  echo "âŒ Error: package.json not found in frontend directory!"
  echo "ğŸ“‚ Frontend directory contents:"
  ls -la
  exit 1
fi

# npm ì„¤ì¹˜ í™•ì¸
echo "ğŸ” Checking npm installation..."
if ! command -v npm &> /dev/null; then
  echo "âŒ Error: npm is not installed or not in PATH!"
  exit 1
fi
echo "âœ… npm version: $(npm --version)"

# node_modules ì¡´ì¬ í™•ì¸
if [ ! -d "node_modules" ]; then
  echo "âš ï¸  Warning: node_modules not found. Running npm install..."
  npm install
  if [ $? -ne 0 ]; then
    echo "âŒ Error: npm install failed!"
    exit 1
  fi
  echo "âœ… npm install completed successfully"
fi

# Playwright ì„¤ì¹˜ í™•ì¸
echo "ğŸ” Checking Playwright installation..."
if ! npx playwright --version &> /dev/null; then
  echo "âš ï¸  Warning: Playwright not found. Installing Playwright..."
  npm install --save-dev @playwright/test
  npx playwright install --with-deps
  if [ $? -ne 0 ]; then
    echo "âŒ Error: Playwright installation failed!"
    exit 1
  fi
  echo "âœ… Playwright installation completed successfully"
else
  echo "âœ… Playwright version: $(npx playwright --version)"
fi

echo ""
echo "ğŸ—ï¸  Building application for E2E tests..."
echo "ğŸ“… Build start time: $(date '+%Y-%m-%d %H:%M:%S')"
npm run build
BUILD_EXIT_CODE=$?
echo "ğŸ“… Build end time: $(date '+%Y-%m-%d %H:%M:%S')"

if [ $BUILD_EXIT_CODE -ne 0 ]; then
  echo "âŒ Error: Build failed with exit code $BUILD_EXIT_CODE"
  echo "ğŸ” Please check the build errors above and fix them"
  exit $BUILD_EXIT_CODE
fi
echo "âœ… Build completed successfully"

echo ""
echo "ğŸ­ Running E2E tests..."
echo "ğŸ“… E2E test start time: $(date '+%Y-%m-%d %H:%M:%S')"
echo "ğŸŒ Starting development server for E2E tests..."

# ë°±ê·¸ë¼ìš´ë“œì—ì„œ ê°œë°œ ì„œë²„ ì‹œì‘
npm run dev &
DEV_SERVER_PID=$!

# ê°œë°œ ì„œë²„ê°€ ì‹œì‘ë  ë•Œê¹Œì§€ ëŒ€ê¸°
echo "â³ Waiting for development server to start..."
sleep 5

# ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
if ! curl -s http://localhost:3000 > /dev/null; then
  echo "âš ï¸  Development server may not be ready yet. Waiting additional 5 seconds..."
  sleep 5
fi

# E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰
echo "ğŸ§ª Running Playwright E2E tests..."
npm run test:e2e
E2E_EXIT_CODE=$?

# ê°œë°œ ì„œë²„ ì¢…ë£Œ
echo "ğŸ›‘ Stopping development server..."
kill $DEV_SERVER_PID 2>/dev/null || true
wait $DEV_SERVER_PID 2>/dev/null || true

echo "ğŸ“… E2E test end time: $(date '+%Y-%m-%d %H:%M:%S')"

if [ $E2E_EXIT_CODE -ne 0 ]; then
  echo "âŒ Error: E2E tests failed with exit code $E2E_EXIT_CODE"
  echo "ğŸ” Please check the E2E test failures above and fix them"
  echo "ğŸ“Š E2E test report available at: frontend/playwright-report/index.html"
  exit $E2E_EXIT_CODE
fi

echo "âœ… E2E tests completed successfully"

echo ""
echo "ğŸ‰ Pre-push E2E testing completed successfully!"
echo "ğŸ“Š Summary:"
echo "  - Build: âœ… Passed"
echo "  - E2E Tests: âœ… Passed"
echo "ğŸ“… Total execution time: $(date '+%Y-%m-%d %H:%M:%S')"
echo "ğŸš€ Pre-push hook completed successfully!"
